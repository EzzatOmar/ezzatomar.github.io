<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Recognizing Emotions via Convolution Networks | ezzatomar</title>
<meta property="og:title" content="Recognizing Emotions via Convolution Networks" />
<meta name="author" content="Omar Ezzat" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Humans can easily recognize the mood of a person by looking at them. Explaining why we know that someone is sad or angry is hard and not trivial at all. To teach machines emotion detection, we simply need to feed a neural network with lots of facial expressions. Lets solve this problem using CNN!" />
<meta property="og:description" content="Humans can easily recognize the mood of a person by looking at them. Explaining why we know that someone is sad or angry is hard and not trivial at all. To teach machines emotion detection, we simply need to feed a neural network with lots of facial expressions. Lets solve this problem using CNN!" />
<link rel="canonical" href="http://localhost:4000/jekyll/update/2017/12/16/First-Post.html" />
<meta property="og:url" content="http://localhost:4000/jekyll/update/2017/12/16/First-Post.html" />
<meta property="og:site_name" content="ezzatomar" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-12-16T11:49:01+00:00" />
<script type="application/ld+json">
{"name":null,"description":"Humans can easily recognize the mood of a person by looking at them. Explaining why we know that someone is sad or angry is hard and not trivial at all. To teach machines emotion detection, we simply need to feed a neural network with lots of facial expressions. Lets solve this problem using CNN!","author":{"@type":"Person","name":"Omar Ezzat"},"@type":"BlogPosting","url":"http://localhost:4000/jekyll/update/2017/12/16/First-Post.html","publisher":null,"image":null,"headline":"Recognizing Emotions via Convolution Networks","dateModified":"2017-12-16T11:49:01+00:00","datePublished":"2017-12-16T11:49:01+00:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/jekyll/update/2017/12/16/First-Post.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="alternate" type="application/rss+xml" title="ezzatomar" href="/feed.xml">
  
  <script src="/assets/js/util.js"></script>
  <script src="/assets/js/keras-wrapper.js"></script>
  <script src="/assets/js/image-manipulation.js"></script>
  <script src="/assets/js/lib/keras2.js"></script>
  <script src="/assets/js/lib/plotly.js"></script>
  <script src="/assets/js/lib/objectdetect.js"></script>
  <script src="/assets/js/lib/objectdetect.frontalface.js"></script>
  <script src="/assets/js/lib/objectdetect.frontalface_alt.js"></script>
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">ezzatomar</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Recognizing Emotions via Convolution Networks</h1>
    <p class="post-meta">
      <time datetime="2017-12-16T11:49:01+00:00" itemprop="datePublished">
        
        Dec 16, 2017
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Humans can easily recognize the mood of a person by looking at them.<br />
Explaining why we know that someone is sad or angry is hard and not trivial at all.<br />
To teach machines emotion detection, we simply need to feed a neural network with lots of facial expressions.<br />
Lets solve this problem using CNN!</p>

<hr />

<h2 id="demo">Demo</h2>

<script> window.myScope = {}; </script>

<script src="/assets/js/recognizer.js"></script>

<style>
  .floatL {
    float: left;
  }
  .floatR {
    float: right;
  }
  .floatN {
    float: none;
  }
</style>

<p><button style="position: relative; bottom: 15px; left: 50%; margin-left: -60px; width: 120px; font-size: 20px;" id="recognizeBtn"><center>Recognize</center></button></p>

<div class="floatN">
  <div class="floatL"><video id="video" width="320" height="240" autoplay=""></video></div>
  <div class="floatR"><canvas width="320" height="240" id="canvas-snapshot" /></div>
</div>
<div style="clear:both;"></div>
<!-- <div class='floatN'><canvas width="400" height="300" id="canvas-to-detect"/></div> -->

<div class="floatN" id="graph"></div>

<h2 id="the-dataset">The Dataset</h2>

<p>The <a href="https://www.kaggle.com/c/challenges-in-representation-learning-facial-expression-recognition-challenge/data" title="Challenges in Representation Learning: Facial Expression Recognition Challenge">Kaggle Dataset</a> is prepared by Pierre-Luc Carrier and Aaron Courville,
consists of 48x48 grayscale images. Itâ€™s divided in 28,709 training, 3,589 testing and 3,589 validation examples.<br />
Each image is labeled in one of seven classes [Angry, Disgust, Fear, Happy, Sad, Surprise].</p>

<p><img src="/assets/images/faces-overview.png" alt="" /></p>

<p>Taking a deeper look at how the emotions are distributed, we notice that <em>Disgust</em> is underrepresented.</p>
<center><img src="/assets/images/image-bar.png" /></center>
<p>Therefore it is removed, leaving 6 emotions to recognize.</p>

<h2 id="cleanup">Cleanup</h2>
<p>The daily life of a data scientist is to clean the data. Analysing the images, we find that there are some problematic data.</p>
<h4 id="overlayed-text">Overlayed Text</h4>
<center><img src="/assets/images/images-overlayed-text.png" style="width: 50%" /></center>

<h4 id="abstract-images">Abstract Images</h4>
<center><img src="/assets/images/images-abstract.png" style="width: 50%" /></center>

<h4 id="mislabel">Mislabel</h4>
<center><img src="/assets/images/images-mislabeled.png" style="width: 12%" /></center>

<h4 id="outlier">Outlier</h4>
<center><img src="/assets/images/images-outlier.png" style="width: 50%" /></center>
<p><br /></p>

<p>To decide which images to keep, we take a simple approach. By calculating the <a href="https://www.hdm-stuttgart.de/~maucher/Python/MMCodecs/html/basicFunctions.html">entropy</a> and sum them to a single number, which we sort. After some experimentation I figured 1% is a good dismiss rate.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># remove 1% of the images with the lowest entropy</span>
  <span class="k">def</span> <span class="nf">removePercentage</span><span class="p">(</span><span class="n">X_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">X_data_entropy</span><span class="p">,</span> <span class="n">percentage</span><span class="p">):</span>
      <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_data</span><span class="p">)</span><span class="o">*</span><span class="n">percentage</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
      <span class="n">indexList</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">X_data_entropy</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>
      <span class="n">indexList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">indexList</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X_data</span><span class="p">,</span> <span class="n">indexList</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">indexList</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="the-model">The Model</h2>
<p><img src="/assets/images/CNN-Emotion-Recognition-Overview.svg" style="width: 100%" /></p>

<p>The model is build using the <a href="https://keras.io/">keras</a> libary.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">createModel</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span>
                     <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">AveragePooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span>
                     <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span>
                     <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">'rmsprop'</span><span class="p">,</span> 
                  <span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></div>
<h2 id="predict">Predict</h2>
<p>To run the model on the browser, we use the awesome javascript wrapper <a href="https://github.com/transcranial/keras-js">keras.js</a>.<br />
After saving and <a href="https://transcranial.github.io/keras-js-docs/conversion/">converting</a> the model for keras.js, we load it and access the webcam.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">KerasJS</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
      <span class="na">filepaths</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">model</span><span class="p">:</span> <span class="nx">modelPath</span><span class="p">,</span>
      <span class="na">weights</span><span class="p">:</span> <span class="nx">weightsPath</span><span class="p">,</span>
      <span class="na">metadata</span><span class="p">:</span> <span class="nx">metaDataPath</span>
      <span class="p">},</span>
      <span class="na">gpu</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'video'</span><span class="p">);</span>

  <span class="c1">// Get access to the camera!</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span> <span class="o">&amp;&amp;</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span> <span class="na">video</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
      <span class="nx">video</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">scope</span><span class="p">.</span><span class="nx">video</span> <span class="o">=</span> <span class="nx">video</span><span class="p">;</span>

  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'recognizeBtn'</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">runRecognizer</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Adding a listener to our button, will execute the runRecognizer function which takes a snapshot, detect the face, resize it to 48x48 and feed the model.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">runRecognizer</span><span class="p">(){</span>
  <span class="nx">getImageFromCamP</span><span class="p">(</span><span class="nx">video</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">detectFace</span><span class="p">);</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">faceImage</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="k">return</span> <span class="nx">resizeImageP</span><span class="p">(</span><span class="nx">faceImage</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">);})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">getGrayscaleData</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">floatArray</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">inputDataStruct</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">'input'</span><span class="p">:</span> <span class="nx">floatArray</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ready</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
      <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">predict</span><span class="p">(</span><span class="nx">inputDataStruct</span><span class="p">)</span>
    <span class="p">});</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">drawOutput</span><span class="p">)</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"ERROR:"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);});</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="result">Result</h2>

<p>The overall accuracy is close to 60% for the testing set.
<img src="/assets/images/Results.png" style="width: 100%" />
<img src="/assets/images/confusionMatrix.png" style="width: 100%" /></p>

  </div>

  
    

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">ezzatomar</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Omar Ezzat
            
            </li>
            
            <li><a href="mailto:ezzato@protonmail.com">ezzato@protonmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/EzzatOmar"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">EzzatOmar</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
